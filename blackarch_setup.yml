---
- hosts: localhost
  become: yes
  vars:
    user: "{{ lookup('env','USER') }}"
    user_home: "/home/{{ user }}"
    timestamp: "{{ lookup('pipe','date +%Y%m%d-%H%M') }}"
    wallpaper_src: "{{ playbook_dir }}/wallpaper.jpg"
    wallpaper_dest: "{{ user_home }}/Pictures/wallpaper.jpg"

  tasks:
  ###############################################################
  # BLACKARCH REPO
  ###############################################################
  - name: Install BlackArch repository
    command: "curl -s https://blackarch.org/strap.sh | bash"
    args:
      warn: false

  ###############################################################
  # PACMAN PENTEST PACKAGES
  ###############################################################
  - name: Install pentest packages (pacman)
    ansible.builtin.pacman:
      name:
        - gobuster
        - hashcat
        - john
        - hydra
        - sqlmap
        - impacket
        - openvpn
        - responder
        - kerbrute
        - dnsutils
        - ffuf
        - masscan
        - netcat
        - gowitness
        - evil-winrm
      state: present
      update_cache: true

  ###############################################################
  # BUILD AND INSTALL YAY
  ###############################################################
  - name: Remove any existing yay build
    file:
      path: "{{ user_home }}/yay"
      state: absent

  - name: Clone yay
    ansible.builtin.git:
      repo: https://aur.archlinux.org/yay.git
      dest: "{{ user_home }}/yay"
    become: true

  - name: Build yay (as user)
    command: makepkg --noconfirm -si --needed
    become_user: "{{ user }}"
    args:
      chdir: "{{ user_home }}/yay"

  ###############################################################
  # AUR PACKAGES USING YAY (RUN AS ROOT!)
  ###############################################################
  - name: Install AUR packages with yay (as root)
    become: true
    command: yay -S --noconfirm --needed --answerclean All brave-bin burpsuite slack-desktop extension-manager flatpak

  ###############################################################
  # FLATPAK INSTALLS
  ###############################################################
  - name: Install Obfuscate (flatpak)
    become_user: "{{ user }}"
    command: flatpak install -y com.obfuscate.Obfuscate

  ###############################################################
  # CLONE GITHUB REPOSITORIES
  ###############################################################
  - name: Clone pentest repos
    ansible.builtin.git:
      repo: "{{ item }}"
      dest: "{{ user_home }}/Tools/{{ item.split('/')[-1] }}"
    with_items:
      - https://github.com/lefayjey/linWinPwn
      - https://github.com/garrettfoster13/sccmhunter
      - https://github.com/MWR-CyberSec/PXEThief
      - https://github.com/SpecterOps/bloodhound-cli
      - https://github.com/Lmarkussen/EvilTelnet
      - https://github.com/Lmarkussen/EvilParser
      - https://github.com/Lmarkussen/EvilFTP
      - https://github.com/Lmarkussen/Bruteforce_wordlist_nor
      - https://github.com/OleFredrik1/remoteKrbRelayx

  ###############################################################
  # WALLPAPER
  ###############################################################
  - name: Ensure Pictures directory exists
    file:
      path: "{{ user_home }}/Pictures"
      state: directory
      mode: '0755'
      owner: "{{ user }}"
      group: "{{ user }}"

  - name: Copy wallpaper from local repo
    copy:
      src: "{{ wallpaper_src }}"
      dest: "{{ wallpaper_dest }}"
      owner: "{{ user }}"
      group: "{{ user }}"

  ###############################################################
  # GNOME EXTENSIONS
  ###############################################################
  - name: Install extension manager (verified)
    become: true
    command: yay -S --noconfirm extension-manager

  ###############################################################
  # GNOME THEMING (DRACULA)
  ###############################################################
  - name: Create local theme folder
    file:
      path: "{{ user_home }}/.themes"
      state: directory
      owner: "{{ user }}"
      group: "{{ user }}"
      mode: '0755'

  - name: Download Dracula GTK
    become_user: "{{ user }}"
    git:
      repo: https://github.com/dracula/gtk.git
      dest: "{{ user_home }}/.themes/Dracula"

  - name: Set GTK theme
    become_user: "{{ user }}"
    command: gsettings set org.gnome.desktop.interface gtk-theme "Dracula"

  ###############################################################
  # SET WALLPAPER
  ###############################################################
  - name: Set wallpaper (Wayland)
    become_user: "{{ user }}"
    command: gsettings set org.gnome.desktop.background picture-uri-dark "file://{{ wallpaper_dest }}"

